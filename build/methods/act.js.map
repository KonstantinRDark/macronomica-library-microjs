{"version":3,"sources":["../../src/methods/act.js"],"names":["app","pin","cb","state","exec","dfd","on","setTimeout","resolve","promise","request","route","manager","find","log","info","reject","code","message","timerId","warn","action","Error","callback","then","Promise","result","clearTimeout","catch","error"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AAEA;;;;kBAIeA,OAAO;AACpB;;;;;;AAMA,SAAO,CAACC,GAAD,EAAMC,EAAN,KAAa;AAClB,QAAIF,IAAIG,KAAJ,yBAAJ,EAA6B;AAC3B,aAAOC,KAAKJ,GAAL,EAAUC,GAAV,EAAeC,EAAf,CAAP;AACD;;AAED,QAAIG,MAAM,qBAAM,MAAMD,KAAKJ,GAAL,EAAUC,GAAV,EAAeC,EAAf,CAAZ,CAAV;;AAEAF,QAAIM,EAAJ,CAAO,SAAP,EAAkB,MAAMC,WAAWF,IAAIG,OAAf,EAAwB,EAAxB,CAAxB;;AAEA,WAAOH,IAAII,OAAX;AACD,GAVD;AAWD,C;;AAED,SAASL,IAAT,CAAcJ,GAAd,EAAmBC,GAAnB,EAAwBC,EAAxB,EAA4B;AAC1B,QAAMG,MAAM,qBAAMH,EAAN,CAAZ;AACA,QAAMQ,UAAU,2BAAYV,GAAZ,EAAiBC,GAAjB,CAAhB;AACA,QAAMU,QAAQX,IAAIY,OAAJ,CAAYC,IAAZ,CAAiB,wBAAMH,OAAN,CAAjB,CAAd;;AAEA,MAAI,CAACC,KAAL,EAAY;AACVX,QAAIc,GAAJ,CAAQC,IAAR,CAAc,iCAAd,EAAgD,EAAEd,GAAF,EAAOS,OAAP,EAAhD;AACA,WAAOL,IAAIW,MAAJ,CAAW;AAChBC,YAAS,4BADO;AAEhBC,eAAS;AAFO,KAAX,CAAP;AAID;;AAED,QAAMC,UAAUZ,WAAW,MAAM;AAC/BP,QAAIc,GAAJ,CAAQM,IAAR,CAAc,0BAAd,EAAyC,EAAEnB,GAAF,EAAOS,OAAP,EAAgBW,QAAQV,MAAMU,MAA9B,EAAzC;AACAhB,QAAIW,MAAJ,CAAW,IAAIM,KAAJ,CAAU,0BAAV,CAAX;AACD,GAHe,yBAAhB;;AAKA,MAAI;AACF,QAAIb,UAAUE,MAAMY,QAAN,CAAeb,OAAf,EAAwBC,KAAxB,CAAd;;AAEA,QAAI,CAACF,OAAD,IAAY,OAAOA,QAAQe,IAAf,KAAwB,UAAxC,EAAoD;AAClDf,gBAAUgB,QAAQjB,OAAR,CAAgBC,OAAhB,CAAV;AACD;;AAEDA,YACGe,IADH,CACQE,UAAU;AACdC,mBAAaR,OAAb;AACAd,UAAIG,OAAJ,CAAYkB,MAAZ;AACD,KAJH,EAKGE,KALH,CAKUC,KAAD,IAAW;AAChBF,mBAAaR,OAAb;AACAd,UAAIG,OAAJ,CAAYqB,KAAZ;AACD,KARH;;AAUA,WAAOxB,IAAII,OAAX;AACD,GAlBD,CAkBE,OAAOoB,KAAP,EAAc;AACd7B,QAAIc,GAAJ,CAAQe,KAAR,CAAe,4BAAf,EAA4C,EAAE5B,GAAF,EAAO4B,KAAP,EAAcnB,OAAd,EAAuBW,QAAQV,MAAMU,MAArC,EAA5C;AACAM,iBAAaR,OAAb;AACA,WAAOd,IAAIW,MAAJ,CAAWa,KAAX,CAAP;AACD;AACF","file":"act.js","sourcesContent":["import defer from './../utils/defer';\nimport makeRequest, { clear } from './../utils/make-request';\nimport { ACT_TIMEOUT, STATE_RUN } from './../constants';\n\n/**\n * @param {app} app\n * @returns {function:app}\n */\nexport default app => {\n  /**\n   * @namespace app.act\n   * @param {string|object} pin\n   * @param {function} [cb]\n   * @returns {app}\n   */\n  return (pin, cb) => {\n    if (app.state === STATE_RUN) {\n      return exec(app, pin, cb);\n    }\n    \n    let dfd = defer(() => exec(app, pin, cb));\n    \n    app.on('running', () => setTimeout(dfd.resolve, 10));\n    \n    return dfd.promise;\n  };\n};\n\nfunction exec(app, pin, cb) {\n  const dfd = defer(cb);\n  const request = makeRequest(app, pin);\n  const route = app.manager.find(clear(request));\n  \n  if (!route) {\n    app.log.info(`Вызов не существующего маршрута`, { pin, request });\n    return dfd.reject({\n      code   : 'error.common/act.not.found',\n      message: 'Вызов не существующего маршрута'\n    });\n  }\n  \n  const timerId = setTimeout(() => {\n    app.log.warn(`error.common/act.timeout`, { pin, request, action: route.action });\n    dfd.reject(new Error('error.common/act.timeout'));\n  }, ACT_TIMEOUT);\n  \n  try {\n    let promise = route.callback(request, route);\n    \n    if (!promise || typeof promise.then !== 'function') {\n      promise = Promise.resolve(promise);\n    }\n    \n    promise\n      .then(result => {\n        clearTimeout(timerId);\n        dfd.resolve(result);\n      })\n      .catch((error) => {\n        clearTimeout(timerId);\n        dfd.resolve(error);\n      });\n    \n    return dfd.promise;\n  } catch (error) {\n    app.log.error(`Ошибка при вызове маршрута`, { pin, error, request, action: route.action });\n    clearTimeout(timerId);\n    return dfd.reject(error);\n  }\n}"]}