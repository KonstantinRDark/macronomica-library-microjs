{"version":3,"sources":["../../src/methods/act.js"],"names":["ERROR_TYPE","ActInternalError","message","type","ActNotFoundError","code","TimeoutError","timeout","app","pin","cb","state","exec","dfd","on","setTimeout","resolve","promise","request","route","manager","find","meta","error","log","warn","reject","timerId","wrapped","action","info","id","callback","then","result","clearTimeout","catch"],"mappings":"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","file":"act.js","sourcesContent":["import TypedError from 'error/typed';\nimport WrappedError from 'error/wrapped';\nimport defer from './../utils/defer';\nimport makeRequest, { clear } from './../utils/make-request';\nimport { ACT_TIMEOUT, STATE_RUN } from './../constants';\n\nconst ERROR_TYPE = 'micro.act';\n\nconst ActInternalError = WrappedError({\n  message: '{name}: {origMessage}',\n  type   : `${ ERROR_TYPE }.internal`\n});\n\nconst ActNotFoundError = TypedError({\n  message: '{name}: Вызов не существующего маршрута',\n  type   : `${ ERROR_TYPE }.not.found`,\n  code   : 404\n});\n\nconst TimeoutError = TypedError({\n  message: '{name}: Превышено время выполнения (timeout={timeout}) запроса',\n  type   : `${ ERROR_TYPE }.timeout`,\n  timeout: null,\n  code   : 408\n});\n\n/**\n * @param {app} app\n * @returns {function:app}\n */\nexport default app => {\n  /**\n   * @namespace app.act\n   * @param {string|object} pin\n   * @param {function} [cb]\n   * @returns {app}\n   */\n  return (pin, cb) => {\n    if (app.state === STATE_RUN) {\n      return exec(app, pin, cb);\n    }\n    \n    let dfd = defer(() => exec(app, pin, cb));\n    \n    app.on('running', () => setTimeout(dfd.resolve, 10));\n    \n    return dfd.promise;\n  };\n};\n\nfunction exec(app, pin, cb) {\n  const dfd = defer(cb);\n  const request = makeRequest(app, pin);\n  const route = app.manager.find(clear(request));\n  const meta = {\n    pin    : clear(request),\n    request: request.request\n  };\n\n  if (!route) {\n    const error = ActNotFoundError();\n    app.log.warn(error.message, meta);\n    return dfd.reject(error);\n  }\n  const timeout = request.timeout || ACT_TIMEOUT;\n  let timerId;\n  \n  if (+timeout !== -1) {\n    timerId = setTimeout(() => {\n      const wrapped = TimeoutError({ timeout });\n      app.log.warn(wrapped, { ...meta, action: route.action });\n      dfd.reject(wrapped);\n    }, timeout);\n  }\n  \n  try {\n    app.log.info(`[${ meta.request.id }] Вызов маршрута (action=${ route.action.id })`, {\n      ...meta,\n      action: route.action\n    });\n    let promise = route.callback(request, route);\n    \n    if (!promise || typeof promise.then !== 'function') {\n      promise = Promise.resolve(promise);\n    }\n    \n    promise\n      .then(result => {\n        if (timerId) { clearTimeout(timerId) }\n        dfd.resolve(result);\n      })\n      .catch((error) => {\n        if (timerId) { clearTimeout(timerId) }\n        dfd.reject(error);\n      });\n    \n  } catch (error) {\n    const wrapped = ActInternalError(error);\n    if (timerId) { clearTimeout(timerId) }\n\n    app.log.error(wrapped, {\n      pin,\n      request: request.request\n    });\n\n    dfd.reject(wrapped);\n  } finally {\n    return dfd.promise;\n  }\n}"]}