{"version":3,"sources":["../../src/methods/act.js"],"names":["app","pin","cb","state","exec","dfd","on","setTimeout","resolve","promise","request","route","manager","find","log","info","reject","code","message","timerId","Error","callback","then","Promise","result","clearTimeout","catch","error","toString"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AAEA;;;;kBAIeA,OAAO;AACpB;;;;;;AAMA,SAAO,CAACC,GAAD,EAAMC,EAAN,KAAa;AAClB,QAAIF,IAAIG,KAAJ,yBAAJ,EAA6B;AAC3B,aAAOC,KAAKJ,GAAL,EAAUC,GAAV,EAAeC,EAAf,CAAP;AACD;;AAED,QAAIG,MAAM,qBAAM,MAAMD,KAAKJ,GAAL,EAAUC,GAAV,EAAeC,EAAf,CAAZ,CAAV;;AAEAF,QAAIM,EAAJ,CAAO,SAAP,EAAkB,MAAMC,WAAWF,IAAIG,OAAf,EAAwB,EAAxB,CAAxB;;AAEA,WAAOH,IAAII,OAAX;AACD,GAVD;AAWD,C;;AAED,SAASL,IAAT,CAAcJ,GAAd,EAAmBC,GAAnB,EAAwBC,EAAxB,EAA4B;AAC1B,QAAMG,MAAM,qBAAMH,EAAN,CAAZ;AACA,QAAMQ,UAAU,2BAAYV,GAAZ,EAAiBC,GAAjB,CAAhB;AACA,QAAMU,QAAQX,IAAIY,OAAJ,CAAYC,IAAZ,CAAiB,wBAAMH,OAAN,CAAjB,CAAd;;AAEA,MAAI,CAACC,KAAL,EAAY;AACVX,QAAIc,GAAJ,CAAQC,IAAR,CAAc,iCAAd,EAAgD,EAAEd,GAAF,EAAhD;AACA,WAAOI,IAAIW,MAAJ,CAAW;AAChBC,YAAS,4BADO;AAEhBC,eAAS;AAFO,KAAX,CAAP;AAID;;AAED,QAAMC,UAAUZ,WAAW,MAAMF,IAAIW,MAAJ,CAAW,IAAII,KAAJ,CAAU,0BAAV,CAAX,CAAjB,yBAAhB;;AAEA,MAAI;AACF,QAAIX,UAAUE,MAAMU,QAAN,CAAeX,OAAf,EAAwBC,KAAxB,CAAd;;AAEA,QAAI,CAACF,OAAD,IAAY,OAAOA,QAAQa,IAAf,KAAwB,UAAxC,EAAoD;AAClDb,gBAAUc,QAAQf,OAAR,CAAgBC,OAAhB,CAAV;AACD;;AAEDA,YACGa,IADH,CACQE,UAAU;AACdC,mBAAaN,OAAb;AACAd,UAAIG,OAAJ,CAAYgB,MAAZ;AACD,KAJH,EAKGE,KALH,CAKUC,KAAD,IAAW;AAChBF,mBAAaN,OAAb;AACAd,UAAIG,OAAJ,CAAYmB,KAAZ;AACD,KARH;;AAUA,WAAOtB,IAAII,OAAX;AACD,GAlBD,CAkBE,OAAOkB,KAAP,EAAc;AACd3B,QAAIc,GAAJ,CAAQa,KAAR,CAAe,4BAAf,EAA4C,EAAE1B,GAAF,EAAO0B,OAAOA,MAAMC,QAAN,EAAd,EAA5C;AACAH,iBAAaN,OAAb;AACA,WAAOd,IAAIW,MAAJ,CAAWW,KAAX,CAAP;AACD;AACF","file":"act.js","sourcesContent":["import defer from './../utils/defer';\nimport makeRequest, { clear } from './../utils/make-request';\nimport { ACT_TIMEOUT, STATE_RUN } from './../constants';\n\n/**\n * @param {app} app\n * @returns {function:app}\n */\nexport default app => {\n  /**\n   * @namespace app.act\n   * @param {string|object} pin\n   * @param {function} [cb]\n   * @returns {app}\n   */\n  return (pin, cb) => {\n    if (app.state === STATE_RUN) {\n      return exec(app, pin, cb);\n    }\n    \n    let dfd = defer(() => exec(app, pin, cb));\n    \n    app.on('running', () => setTimeout(dfd.resolve, 10));\n    \n    return dfd.promise;\n  };\n};\n\nfunction exec(app, pin, cb) {\n  const dfd = defer(cb);\n  const request = makeRequest(app, pin);\n  const route = app.manager.find(clear(request));\n  \n  if (!route) {\n    app.log.info(`Вызов не существующего маршрута`, { pin });\n    return dfd.reject({\n      code   : 'error.common/act.not.found',\n      message: 'Вызов не существующего маршрута'\n    });\n  }\n  \n  const timerId = setTimeout(() => dfd.reject(new Error('error.common/act.timeout')), ACT_TIMEOUT);\n  \n  try {\n    let promise = route.callback(request, route);\n    \n    if (!promise || typeof promise.then !== 'function') {\n      promise = Promise.resolve(promise);\n    }\n    \n    promise\n      .then(result => {\n        clearTimeout(timerId);\n        dfd.resolve(result);\n      })\n      .catch((error) => {\n        clearTimeout(timerId);\n        dfd.resolve(error);\n      });\n    \n    return dfd.promise;\n  } catch (error) {\n    app.log.error(`Ошибка при вызове маршрута`, { pin, error: error.toString() });\n    clearTimeout(timerId);\n    return dfd.reject(error);\n  }\n}"]}