{"version":3,"sources":["../../src/methods/log.js"],"names":["LEVEL_ALL","LEVEL_OFF","LEVEL_INFO","LEVEL_TRACE","LEVEL_DEBUG","LEVEL_WARN","LEVEL_ERROR","LEVEL_FATAL","LEVELS","app","level","logger","log","usePluginLogger","on","process","error","message","payload","Error","stack","replace","id","time","started","code","inspect","depth","details","Date","toISOString","versions","features","moduleLoadList","pid","arch","platform","execPath","argv","env","join","emit","args","push","JSON","stringify","console","warn"],"mappings":"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","file":"log.js","sourcesContent":["import Util from 'util';\n\nexport const LEVEL_ALL = 'all';\nexport const LEVEL_OFF = 'off';\nexport const LEVEL_INFO = 'info';\nexport const LEVEL_TRACE = 'trace';\nexport const LEVEL_DEBUG = 'debug';\nexport const LEVEL_WARN = 'warn';\nexport const LEVEL_ERROR = 'error';\nexport const LEVEL_FATAL = 'fatal';\n/**\n * @name LEVELS\n * @type {Object<string, number>}\n * @enum {number}\n */\nexport const LEVELS = {\n  [ LEVEL_ALL ]: 0,\n\n  [ LEVEL_FATAL ]: 10,\n  [ LEVEL_ERROR ]: 20,\n  [ LEVEL_WARN  ]: 30,\n  [ LEVEL_INFO  ]: 40,\n  [ LEVEL_TRACE ]: 50,\n  [ LEVEL_DEBUG ]: 60,\n\n  [ LEVEL_OFF ]: 100\n};\n\n/**\n * @param {app} app\n * @param { string } [level]\n * @returns {object}\n */\nexport default (app, { level = LEVEL_DEBUG } = {}) => {\n  /**\n   * Levels:\n   *\n   * ALL    Все уровни\n   * OFF    Отключить ведение журнала\n   *\n   * INFO   Информационные сообщения\n   * TRACE  Информационные сообщения, с дополнительной информацией\n   * DEBUG  Информационные события, которые наиболее полезны для отладки приложения.\n   *\n   * WARN   Предупреждения о потенциально опасных ситуациях\n   * ERROR  Ошибка, но которая позволяет приложению продолжать работать\n   * FATAL  Ошибка, которая приводит завершению приложения\n   */\n\n  /**\n   * @namespace app.log\n   */\n  const logger = {\n    /**\n     * @memberof app.log\n     * @type {string}\n     */\n    level,\n    /**\n     * @memberof app.log\n     * @type {Object<!string, !number>}\n     */\n    LEVELS,\n    /**\n     * @memberof app.log\n     * @name debug\n     * @param {string} message\n     * @param {*} [payload]\n     */\n    [ LEVEL_DEBUG ]: log(LEVEL_DEBUG),\n    /**\n     * @memberof app.log\n     * @name trace\n     * @param {string} message\n     * @param {*} [payload]\n     */\n    [ LEVEL_TRACE ]: log(LEVEL_TRACE),\n    /**\n     * @memberof app.log\n     * @name info\n     * @param {string} message\n     * @param {*} [payload]\n     */\n    [ LEVEL_INFO ] : log(LEVEL_INFO),\n    /**\n     * @memberof app.log\n     * @name warn\n     * @param {string} message\n     * @param {*} [payload]\n     */\n    [ LEVEL_WARN ] : log(LEVEL_WARN),\n    /**\n     * @memberof app.log\n     * @name error\n     * @param {string} message\n     * @param {*} [payload]\n     */\n    [ LEVEL_ERROR ]: log(LEVEL_ERROR),\n    /**\n     * @memberof app.log\n     * @name fatal\n     * @param {string} message\n     * @param {*} [payload]\n     */\n    [ LEVEL_FATAL ]: log(LEVEL_FATAL)\n  };\n  let usePluginLogger;\n\n  app.on('plugin.logger.use', () => usePluginLogger = true);\n  app.on('plugin.logger.unuse', () => usePluginLogger = false);\n\n  process.on('uncaughtException', logger.error);\n\n  return logger;\n\n  /**\n   * @param {string} level\n   * @returns {function(string, payload)}\n   */\n  function log(level) {\n    return (message, payload) => {\n      if (LEVELS[ logger.level ] < LEVELS[ level ]) {\n        return logger;\n      }\n\n      if (level === LEVEL_FATAL) {\n        const error = message instanceof Error ? message : new Error(message);\n        let stack = error.stack || '';\n        stack = stack\n          .replace(/^.*?\\n/, '\\n')\n          .replace(/\\n/g, '\\n          ')\n        ;\n\n        message = [\n          '\\n',\n          '##############################################################################################',\n          `# Fatal Error`,\n          '# Instance  : ' + app.id,\n          '# Started At: ' + app.time.started,\n          '# =========================================================================================== ',\n          '  Message   : ' + error.message,\n          '  Code      : ' + error.code,\n          '  Payload   : ' + Util.inspect(payload, { depth: null }),\n          '  Details   : ' + Util.inspect(error.details, { depth: null }),\n          '  When      : ' + (new Date()).toISOString(),\n          '  Stack     : ' + stack,\n          '  Node      : ' + Util.inspect(process.versions).replace(/\\s+/g, ' '),\n          '              ' + Util.inspect(process.features).replace(/\\s+/g, ' '),\n          '              ' + Util.inspect(process.moduleLoadList).replace(/\\s+/g, ' '),\n          '  Process   : ',\n          '              pid=' + process.pid,\n          '              arch=' + process.arch,\n          '              platform=' + process.platform,\n          '              path=' + process.execPath,\n          '              argv=' + Util.inspect(process.argv).replace(/\\n/g, ''),\n          '              env=' + Util.inspect(process.env).replace(/\\n/g, ''),\n          '##############################################################################################'\n        ].join('\\n');\n      }\n\n      if (level === LEVEL_ERROR && message instanceof Error) {\n        const error = message;\n        let stack = error.stack || '';\n        stack = stack\n          .replace(/^.*?\\n/, '\\n')\n          .replace(/\\n/g, '\\n          ')\n        ;\n\n        message = [\n          '\\n',\n          '##############################################################################################',\n          `# Error`,\n          '# =========================================================================================== ',\n          '  Instance  : ' + app.id,\n          '  Message   : ' + error.message,\n          '  Code      : ' + error.code,\n          '  Payload   : ' + Util.inspect(payload, { depth: null }),\n          '  Details   : ' + Util.inspect(error.details, { depth: null }),\n          '  When      : ' + (new Date()).toISOString(),\n          '  Stack     : ' + stack,\n          '  Node      : ' + Util.inspect(process.versions).replace(/\\s+/g, ' '),\n          '              ' + Util.inspect(process.features).replace(/\\s+/g, ' '),\n          '              ' + Util.inspect(process.moduleLoadList).replace(/\\s+/g, ' '),\n          '  Process   : ',\n          '              pid=' + process.pid,\n          '              arch=' + process.arch,\n          '              platform=' + process.platform,\n          '              path=' + process.execPath,\n          '              argv=' + Util.inspect(process.argv).replace(/\\n/g, ''),\n          '              env=' + Util.inspect(process.env).replace(/\\n/g, ''),\n          '##############################################################################################'\n        ].join('\\n');\n      }\n\n      if (usePluginLogger) {\n        app.emit('log', { level, message, payload });\n        app.emit(`log.${ level }`, { level, message, payload });\n      } else {\n        const args = [ `${ level }\\t`, message ];\n\n        if (!!payload) {\n          args.push(JSON.stringify(payload, '', 4));\n        }\n\n        switch (level) {\n          case LEVEL_ERROR:\n          case LEVEL_FATAL:\n            console.error(...args);\n            break;\n          case LEVEL_WARN:\n            console.warn(...args);\n            break;\n          default:\n            console.log(...args);\n        }\n      }\n\n      return logger;\n    };\n  }\n}"]}