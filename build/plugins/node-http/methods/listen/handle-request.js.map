{"version":3,"sources":["../../../../../src/plugins/node-http/methods/listen/handle-request.js"],"names":["handleRequest","ERROR_TYPE","InternalError","message","type","code","method","UrlNotFoundError","url","CallPrivateMethodError","request","ActError","app","settings","req","res","next","_originalUrl","parse","query","pathnameUrl","pathname","error","log","responseError","catch","then","pin","body","meta","transport","errmeta","id","role","warn","owner","duration","join","info","act","success","result","level","status","Error","outJson","writeHead","Buffer","byteLength","end","originalError","json","fullType","statusMessage","STATUS_CODES"],"mappings":"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","file":"handle-request.js","sourcesContent":["import WrappedError from 'error/wrapped';\nimport TypedError from 'error/typed';\n\nimport http from 'http';\nimport buffer from 'buffer';\nimport qs from 'qs';\nimport url from 'url';\nimport getRequest from './get-request';\nimport applyPreprocessors from './apply-preprocessors';\n\nimport {\n  SERVER_PREFIX,\n  RESPONSE_PROPERTY_STATUS,\n  RESPONSE_PROPERTY_RESULT,\n  RESPONSE_STATUS_SUCCESS,\n  RESPONSE_STATUS_ERROR\n} from './../../constants';\n\nconst ERROR_TYPE = 'micro.plugin.http-node';\n\nconst InternalError = WrappedError({\n  message: '[{code}:{method}:error] - {origMessage}',\n  type   : `${ ERROR_TYPE }.internal`,\n  code   : 500,\n  method : null\n});\n\nconst UrlNotFoundError = TypedError({\n  message: '{name} - не поддерживаемый url: {url}',\n  type   : `${ ERROR_TYPE }.url.not.found`,\n  code   : 404,\n  url    : null\n});\n\nconst CallPrivateMethodError = TypedError({\n  message: '{name} - попытка вызова приватного метода: [request]{url}',\n  type   : `${ ERROR_TYPE }.call.private.method`,\n  code   : 404,\n  url    : null,\n  request: null\n});\n\nconst ActError = WrappedError({\n  message: '[{request}] | {code} {method} error | {origMessage}',\n  type   : `${ ERROR_TYPE }.act`,\n  request: null,\n  code   : null,\n  method : null\n});\n\nexport default function handleRequest(app, settings){\n  return (req, res, next) => {\n    req._originalUrl = req.url;\n    req.url = url.parse(req.url);\n    req.query = qs.parse(req.url.query);\n\n    const pathnameUrl = req.url.pathname;\n\n    if (req.url.pathname !== SERVER_PREFIX) {\n      let error = UrlNotFoundError({ url: pathnameUrl });\n      app.log.error(error.message, { error });\n      return responseError(res, error);\n    }\n\n    applyPreprocessors(app, req, res, pathnameUrl)\n      .catch(error => responseError(res, error))\n      .then(() => {\n        const pin = {\n          ...(req.body || {}),\n          ...req.query\n        };\n        const request = getRequest(app, req, pin);\n\n        const meta = {\n          request  : request.request,\n          transport: request.transport\n        };\n        const errmeta = {\n          request: request.request.id,\n          url    : pathnameUrl\n        };\n\n        if (pin.role === 'plugin') {\n          let error = CallPrivateMethodError(errmeta);\n          app.log.warn(error.message, meta);\n          return responseError(res, error);\n        }\n\n        const message = [\n          `[${ request.request.owner }]`,\n          `--- ${ req.method } - run -`,\n          `${ request.duration() }ms`\n        ].join(' | ');\n\n        app.log.info(message, meta);\n\n        return app.act({ ...request, ...pin })\n          .then(\n            success(request, pin, req, res),\n            error(request, pin, req, res)\n          );\n      });\n  };\n}\n\nfunction success(request, pin, req, res) {\n  return result => {\n    const level = 'info';\n    const code = 200;\n    let status = RESPONSE_STATUS_SUCCESS;\n\n    if (result instanceof Error) {\n      status = RESPONSE_STATUS_ERROR;\n      result = result.type;\n    }\n\n    const meta = {\n      request  : request.request,\n      transport: request.transport\n    };\n\n    const outJson = JSON.stringify({\n      [ RESPONSE_PROPERTY_STATUS ]: status,\n      [ RESPONSE_PROPERTY_RESULT ]: result\n    });\n\n    res.writeHead(code, {\n      'Content-Type'  : 'application/json',\n      // 'Cache-Control' : 'private, max-age=0, no-cache, no-store',\n      'Content-Length': buffer.Buffer.byteLength(outJson)\n    });\n\n    const message = [\n      `[${ request.request.owner }]`,\n      `${ code } ${ req.method } ${ status }`,\n      `${ request.duration() }ms`\n    ].join(' | ');\n\n    request.log[ level ](message, meta);\n\n    res.end(outJson);\n  };\n}\n\nfunction error(request, pin, req, res) {\n  return (originalError) => {\n    let error;\n\n    request.duration();\n\n    switch (originalError.type) {\n      case 'micro.act.timeout':\n      case 'micro.act.not.found': {\n        error = ActError(originalError, {\n          request: request.request.id,\n          code   : originalError.code,\n          method : req.method\n        });\n        break;\n      }\n      default: {\n        error = InternalError(originalError, { method: req.method });\n      }\n    }\n\n    const meta = {\n      request: request.request,\n      error,\n      pin\n    };\n\n    request.log.error(error.message, { ...meta, error });\n\n    responseError(res, error);\n  };\n}\n\nfunction responseError(res, error) {\n  const code = error.code || 500;\n  const json = JSON.stringify({\n    [ RESPONSE_PROPERTY_STATUS ]: RESPONSE_STATUS_ERROR,\n    [ RESPONSE_PROPERTY_RESULT ]: error.fullType || error.type\n  });\n\n  res.writeHead(code, {\n    'Content-Type'  : 'application/json',\n    // 'Cache-Control' : 'private, max-age=0, no-cache, no-store',\n    'Content-Length': buffer.Buffer.byteLength(json)\n  });\n\n  res.statusMessage = http.STATUS_CODES[ code ];\n  res.end(json);\n}"]}