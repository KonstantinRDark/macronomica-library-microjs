{"version":3,"sources":["../../../../../src/plugins/node-http/methods/listen/handle-request.js"],"names":["handleRequest","PREFIX_LOG","InternalError","message","type","code","method","UrlNotFoundError","url","CallPrivateMethodError","request","ActError","app","settings","req","res","next","_originalUrl","parse","query","pathnameUrl","pathname","error","log","responseError","catch","then","body","pin","meta","transport","duration","role","private","id","warn","trace","act","success","result","status","Error","outJson","writeHead","Buffer","byteLength","end","originalError","json","fullType","statusMessage","STATUS_CODES"],"mappings":"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","file":"handle-request.js","sourcesContent":["import WrappedError from 'error/wrapped';\nimport TypedError from 'error/typed';\n\nimport http from 'http';\nimport buffer from 'buffer';\nimport qs from 'qs';\nimport url from 'url';\nimport getRequest from './get-request';\nimport applyPreprocessors from './apply-preprocessors';\n\nimport {\n  SERVER_PREFIX,\n  RESPONSE_PROPERTY_STATUS,\n  RESPONSE_PROPERTY_RESULT,\n  RESPONSE_STATUS_SUCCESS,\n  RESPONSE_STATUS_ERROR\n} from './../../constants';\n\nconst PREFIX_LOG = 'micro.plugins.http-node.handle-request';\n\nconst InternalError = WrappedError({\n  message: '[{code}:{method}:error] - {origMessage}',\n  type   : `${ PREFIX_LOG }.internal`,\n  code   : 500,\n  method : null\n});\n\nconst UrlNotFoundError = TypedError({\n  message: '{name} - не поддерживаемый url: {url}',\n  type   : `${ PREFIX_LOG }.url.not.found`,\n  code   : 404,\n  url    : null\n});\n\nconst CallPrivateMethodError = TypedError({\n  message: '{name} - попытка вызова приватного метода: [request]{url}',\n  type   : `${ PREFIX_LOG }.call.private.method`,\n  code   : 404,\n  url    : null,\n  request: null\n});\n\nconst ActError = WrappedError({\n  message: '[{request}] | {code} {method} error | {origMessage}',\n  type   : `${ PREFIX_LOG }.act`,\n  request: null,\n  code   : null,\n  method : null\n});\n\nexport default function handleRequest(app, settings){\n  return (req, res, next) => {\n    req._originalUrl = req.url;\n    req.url = url.parse(req.url);\n    req.query = qs.parse(req.url.query);\n\n    const pathnameUrl = req.url.pathname;\n\n    if (req.url.pathname !== SERVER_PREFIX) {\n      let error = UrlNotFoundError({ url: pathnameUrl });\n      app.log.error(error.message, { error });\n      return responseError(res, error);\n    }\n\n    applyPreprocessors(app, req, res, pathnameUrl)\n      .catch(error => responseError(res, error))\n      .then(() => {\n        const body = (req.body || {});\n        const query = (req.query || {});\n        const pin = {\n          ...body,\n          ...query\n        };\n        const request = getRequest(app, req, pin);\n\n        const meta = {\n          /* pin, */\n          /* body,\n          query, */\n          method   : req.method,\n          request  : request.request,\n          transport: request.transport\n        };\n\n        request.duration();\n\n        if (pin.role === 'plugin' || ('private' in pin && pin.private === true)) {\n          let error = CallPrivateMethodError({\n            request: meta.request.id,\n            url    : pathnameUrl\n          });\n          app.log.warn(error.message, meta);\n          return responseError(res, error);\n        }\n\n        app.log.trace(PREFIX_LOG, meta);\n\n        return request.act(pin).then(\n          success(request, res, meta),\n          error(request, res, meta)\n        );\n      });\n  };\n}\n\nfunction success(request, res, meta) {\n  return result => {\n    const code = 200;\n    let status = RESPONSE_STATUS_SUCCESS;\n\n    if (result instanceof Error) {\n      status = RESPONSE_STATUS_ERROR;\n      result = result.type;\n    }\n\n    const outJson = JSON.stringify({\n      [ RESPONSE_PROPERTY_STATUS ]: status,\n      [ RESPONSE_PROPERTY_RESULT ]: result\n    });\n\n    res.writeHead(code, {\n      'Content-Type'  : 'application/json',\n      // 'Cache-Control' : 'private, max-age=0, no-cache, no-store',\n      'Content-Length': buffer.Buffer.byteLength(outJson)\n    });\n    request.duration();\n    request.log.trace(PREFIX_LOG, { status, /*result,*/ ...meta });\n\n    res.end(outJson);\n  };\n}\n\nfunction error(request, res, meta) {\n  return (originalError) => {\n    let error;\n\n    request.duration();\n\n    switch (originalError.type) {\n      case 'micro.act.timeout':\n      case 'micro.act.not.found': {\n        error = ActError(originalError, {\n          request: meta.request.id,\n          code   : originalError.code,\n          method : meta.method\n        });\n        break;\n      }\n      default: {\n        error = InternalError(originalError, { method: meta.method });\n      }\n    }\n\n    if (originalError.type !== 'micro.act.not.found') {\n      request.log.error(error.message, { ...meta, error });\n    }\n\n    responseError(res, error);\n  };\n}\n\nfunction responseError(res, error) {\n  const code = error.code || 500;\n  const json = JSON.stringify({\n    [ RESPONSE_PROPERTY_STATUS ]: RESPONSE_STATUS_ERROR,\n    [ RESPONSE_PROPERTY_RESULT ]: error.fullType || error.type\n  });\n\n  res.writeHead(code, {\n    'Content-Type'  : 'application/json',\n    // 'Cache-Control' : 'private, max-age=0, no-cache, no-store',\n    'Content-Length': buffer.Buffer.byteLength(json)\n  });\n\n  res.statusMessage = http.STATUS_CODES[ code ];\n  res.end(json);\n}"]}