{"version":3,"sources":["../../src/utils/make-request.js"],"names":["clear","app","raw","TRANSPORT","type","trace","origin","name","clearOldRequest","transport","request","msg","req","newReq","duration","wrapRequest","act","pin","process","hrtime","time","seconds","nanoseconds","end","Date","now","parent","original","oId","owner","start","id","join","appId","appName","log"],"mappings":"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","file":"make-request.js","sourcesContent":["import isString from 'lodash.isstring';\nimport jsonic from 'jsonic';\nimport { version } from '../../package.json';\nimport genid from './genid';\nimport { round } from './mdn-decimal-adjust';\n\nexport {\n  clear\n};\n\nexport default (app, raw) => {\n  if (isString(raw)) {\n    raw = jsonic(raw);\n  }\n\n  const TRANSPORT = {\n    type  : 'inner',\n    trace : [],\n    origin: `microjs-${ app.name !== 'microjs' ? app.name : '' }-v${ version }`\n  };\n\n  const { transport = TRANSPORT, request, ...msg } = clearOldRequest(raw);\n  const req = newReq(app);\n\n  Object.assign(req, {\n    ...msg,\n    transport,\n    duration,\n    request: wrapRequest(request),\n    act    : (pin) => {\n      if (isString(pin)) { pin = jsonic(pin) }\n      const { request, transport } = req;\n      return app.act({ ...pin, request, transport });\n    }\n  });\n\n  return req;\n\n  function duration() {\n    const [ seconds, nanoseconds ] = process.hrtime(req.request.time.hrtime);\n    req.request.time.end = Date.now();\n    return req.request.time.duration = round((seconds * 1000) + (nanoseconds * 1e-6), -3);\n  }\n};\n\nfunction wrapRequest({\n  original:parent,\n  owner:oId,\n  trace = []\n} = {}) {\n  const original = genid();\n  const owner = oId || original;\n  const start = Date.now();\n  const hrtime = process.hrtime();\n  const id = [\n    owner + (original !== owner || !!parent ? ':~:' : ''),\n    !!parent ? parent + '~>~' : '',\n    original !== owner ? original : ''\n  ].join('');\n\n  trace = !!parent ? [ ...trace, original ] : [];\n\n  return {\n    id,\n    time: { hrtime, start },\n    original,\n    parent,\n    owner,\n    trace\n  };\n}\n\nfunction newReq(app) {\n  return {\n    get appId() { return app.id },\n\n    get appName() { return app.name },\n\n    get log() { return app.log },\n  };\n}\n\nfunction clearOldRequest({ appId, appName, log, duration, act, ...msg }) {\n  return msg;\n}\n\nfunction clear({ appId, appName, log, duration, act, transport, request, ...msg } = {}) {\n  return msg;\n}"]}